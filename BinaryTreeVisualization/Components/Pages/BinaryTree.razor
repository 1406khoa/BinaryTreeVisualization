@page "/binarytree"
@rendermode InteractiveServer
@inject TreeService treeService

<h3>Binary Tree Visualization</h3>

<div>
    <h4>Add Node</h4>
    <input type="number" @bind="newNodeValue" />
    <button @onclick="AddNode">Add Node</button>
</div>

<!-- Khối SVG -->
<svg width="100%" height="100vh" style="overflow: visible;">
    @foreach (var line in lines)
    {
        <line x1="@line.x1" y1="@line.y1" x2="@line.x2" y2="@line.y2" stroke="black" stroke-width="2" />
    }

    @foreach (var nodePosition in nodePositions)
    {
        <!-- Vẽ hình tròn cho node -->
        <circle cx="@nodePosition.x" cy="@nodePosition.y" r="20" stroke="black" stroke-width="2" fill="white" />

        <!-- Sử dụng RenderTreeBuilder để in giá trị -->
        @((RenderFragment)((builder) =>
            {
                builder.OpenElement(0, "text");
                builder.AddAttribute(1, "x", nodePosition.x);
                builder.AddAttribute(2, "y", nodePosition.y);
                builder.AddAttribute(3, "text-anchor", "middle");
                builder.AddAttribute(4, "dominant-baseline", "middle");
                builder.AddAttribute(5, "dy", "0.35em"); // Điều chỉnh vị trí văn bản
                builder.AddAttribute(6, "font-size", "12");
                builder.AddAttribute(7, "font-weight", "bold");
                builder.AddAttribute(8, "fill", "black");
                builder.AddContent(9, nodePosition.node.Value.ToString());
                builder.CloseElement();
            }))
    }
</svg>

@code {
    @using BinaryTreeVisualization.Components.Services
    private int newNodeValue;
    private List<(NodeService node, double x, double y)> nodePositions = new List<(NodeService node, double x, double y)>();
    private List<(double x1, double y1, double x2, double y2)> lines = new List<(double x1, double y1, double x2, double y2)>();

    protected override void OnInitialized()
    {
        // Không cần khởi tạo lại treeService ở đây nếu đã được tiêm
    }

    private void AddNode()
    {
        treeService.AddNode(newNodeValue);
        UpdateTreeDrawing();
    }

    private void UpdateTreeDrawing()
    {
        // Cập nhật nodePositions bằng cách gọi hàm GetNodePositions
        nodePositions = treeService.GetNodePositions(treeService.Root);
        lines = treeService.GetLines(); // Lấy danh sách các đường nối
    }
}
